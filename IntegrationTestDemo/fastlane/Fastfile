desc "Run UI Tests"
lane :ui_tests do
  udid = ENV['SIMULATOR_UDID']
  if udid.nil? || udid.empty?
    UI.user_error!("No SIMULATOR_UDID found! Make sure CI sets it via simctl create.")
  end

  destination = "'id=#{udid}'"

  # Build once for testing
  sh "xcodebuild build-for-testing \
      -project IntegrationTestDemo.xcodeproj \
      -scheme IntegrationTestDemo \
      -destination #{destination} \
      -derivedDataPath ./fastlane/derived_data \
      -quiet"

  # Run tests without rebuilding
  sh "xcodebuild test-without-building \
      -project IntegrationTestDemo.xcodeproj \
      -scheme IntegrationTestDemo \
      -destination #{destination} \
      -maximum-concurrent-test-simulator-destinations 1 \
      -resultBundlePath ./fastlane/test_output/IntegrationTestDemo.xcresult \
      -quiet"

  # Optional: Generate HTML/JUnit reports if xchtmlreport is available
  begin
    xcresulttool = "./fastlane/test_output/IntegrationTestDemo.xcresult"
    sh "xchtmlreport -r #{xcresulttool} -o ./fastlane/test_output"
  rescue
    UI.message("xchtmlreport not installed, skipping HTML report generation")
  end
end

